# 使用 zeek 来完成取证分析

## Kali Rolling 发行版注意事项
自 2019-08-04 之后，Bro 的软件包已经从 Kali 官方软件源镜像仓库中移除，因此建议按照 Zeek 官方安装指南 在 Kali 系统上安装和配置 Zeek 。

## 安装 zeek

拉取镜像，检查镜像目录
![图片](1.png)

## 实验环境基本信息
安装、检查、运行容器，并查看环境信息
![图片](2.png)

![图片](3.png)

## 编辑 zeek 配置文件
1.在本地修改配置文件后，复制到容器内
编辑 local.zeek文件，在文件尾部追加两⾏新配置代码
@load frameworks/files/extract-all-files
@load mytuning.zeek

2.执行对应命令：
docker cp local.zeek
(输入容器ID):/usr/local/zeek/s
hare/zeek/site/

3.创建 mytuning.zeek文件 ，在其内部添加以下内容
redef ignore_checksums = T;

4.执⾏对应命令：
docker cp mytuning.zeek
(输入容器ID):/usr/local/zeek/s
hare/zeek/site/

![图片](4.png)

![图片](5.png)

## 用 zeek 自动化分析 pcap 文件

1.将要分析的文件复制到容器内的 pcap 文件⽬录下

2.在要分析的 pcap 文件⽬录下，执⾏分析命令：
zeek -r attack-trace.pcap /usr/local/zeek/share/zeek/site/local.zeek

![图片](6.png)

3.发现⽣成了⼀些 .log 文件和extract_files

![图片](7.png)

4.上传到 virustotal 扫描，发现它是一个后⻔程序
![图片](8.png)

5.查看各个文件 在 files.log 中发现 “特殊字符”
![图片](9.png)

6. coon.log 文件中特殊字符与它重复，并且通过 conn.log 的会话标识匹配，能够发现该 PE 文件的 IPv4 地址
![图片](10.png)

## Zeek 的一些其他技巧

1.ftp.log 中默认不会显示捕获的 FTP 登录口令，我们可以通过在 /usr/local/zeek/share/zeek/site/mytuning.zeek 中增加以下变量重定义来实现：
redef FTP::default_capture_password = T;
![图片](11.png)
![图片](12.png)

2.使用正确的分隔符进行过滤显示的重要性
从头开始查看日志文件，显示前1行
head -n1 conn.log

Bro的日志文件默认使用的分隔符显示为ASCII码\x09，通过以下命令可以查看该ASCII码对应的“可打印字符”
echo -n -e '\x09' | hexdump -c

使用awk打印给定日志文件的第N列数据
awk -F '\t' '{print $3}' conn.log

![图片](13.png)

3.查看Bro的超长行日志时的横向滚动技巧
less -S conn.log
![图片](14.png)

4.使用 zeek-cut 更“优雅”的查看日志中关注的数据列
查看conn.log中所有可用的“列名”
grep ^#fields conn.log | tr '\t' '\n'

![图片](15.png)

5.按照“列名”输出conn.log中我们关注的一些“列”
zeek-cut ts id.orig_h id.orig_p id.resp_h id_resp_p proto < conn.log

![图片](16.png)

6.将UNIX时间戳格式转换成人类可读的时间（但该方法对于大日志文件处理性能非常低）
zeek-cut -d < conn.log

![图片](17.png)

